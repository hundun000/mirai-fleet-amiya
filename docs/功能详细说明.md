## 1. 概述

示例将以如下格式给出：
>  -> 这是一句指令/事件示例  
>  <- 这是bot对该指令/事件的回复

本插件的功能说明将按模块划分来介绍。而每个模块内的功能，按照触发方式又可划分为：指令触发、事件触发、定时触发。

### 1.1 指令触发

语法遵循mirai-console的Command的默认语法规则，本文假设`<指令前缀>`为`/`：

> <指令前缀><指令名> <子指令> <指令参数列表>

本插件提供两套**等效**的`<指令名>`。

第一套可以通过/help查到，但不是设计来给用户使用的，下文各个功能模块说明里也不会再列出。

例如：
>  -> /阿米娅WeiboFunction 微博订阅 <arg1>

第二套，即是所有指令都统一使用`阿米娅`作为`<指令名>`。推荐用户只使用这一种。

例如：
>  -> /阿米娅 微博订阅 <arg1>

### 1.2 事件触发

某些功能由事件来触发。例如: 不属于指令的任意文本消息事件、戳一戳事件。

### 1.3 定时触发

某些功能在满足时间条件时触发。例如：整点报时。

## 2 功能模块

如上文所述，统一使用`阿米娅`作为`<指令名>`，本章节只介绍`<子指令>`。

### 2.1 微博功能模块

#### 【指令】更新订阅数据

【注意】第一次启用该插件，或修改`WeiboConfig.json`添加了新的微博uid后需要执行一次。在miral-console内执行该指令即可。

特别的，该指令只有第一套的格式：

>  -> /阿米娅WeiboFunction 刷新微博订阅  
> <- 已刷新

#### 【指令】查看最新微博

*<子指令>: 最新微博*  
*<指令参数列表>: [可选]微博用户名*

若不带`微博用户名`参数，则回复该角色订阅的所有微博用户的最新一条微博的更新时间

>  -> /阿米娅 最新微博  
> <- 来自：明日方舟Arknights，最新的饼的时间是：2021-11-30T15:00:06  
>    来自：明日方舟朝陇山，最新的饼的时间是：2021-12-01T10:00:01  
>    来自：泰拉记事社，最新的饼的时间是：2021-11-28T11:00:03  

若带`微博用户名`参数，则回复指定微博用户的最新一条微博的内容

>  -> /阿米娅 最新微博 明日方舟朝陇山  
> <- 新饼！来自：明日方舟朝陇山 2021-12-01T10:00:01  
>    
>   
> 今天是十二月的第一天！不知道2021年的最后一个月，大家是忙碌还是清闲呢~   
> 以及1张图片。   

#### 【指令】查看微博订阅关系

*<子指令>: 微博订阅*  

简单打印微博订阅关系配置，仅作为调试。

>  -> /阿米娅 微博订阅  
> <- {3837704366=FIRST_IMAGE}

配置方法：

手动编辑`config\hundun.fleet.amiya\WeiboFunction\WeiboConfig.json`

#### 微博输出格式

|输出格式|说明|
|----|----|
|NO_IMAGE|不输出图片|
|FIRST_IMAGE|最多输出一张图片|
|ALL_IMAGE|输出所有图片|

根据账号配图特点，选择微博输出格式。例如：
- 某个账号主要发的是9宫格拼图，而bot输出的图片无法保持九宫格形状，输出的意义不大，可以选择`NO_IMAGE`；
- 某个账号主要发的是单张图，有时发9宫格，可以选择`FIRST_IMAGE`；
- 某个账号主要发的是多张图，且每张图都需要输出，可以选择`ALL_IMAGE`；

#### 【自动】推送微博

插件定时检查已订阅的微博，若有新微博，则会自动发送到群里。

> <- 新饼！来自：明日方舟朝陇山 2021-12-01T10:00:01
> 
> 
> 今天是十二月的第一天！不知道2021年的最后一个月，大家是忙碌还是清闲呢~ 
> 以及1张图片。

### 2.2 事项提醒功能模块

### 【定时】整点报时

定时触发。报时文本来自配置文件。

>  <- 早上九点到了。嗯？啊，是长门！喂！长~门！……嗯？在哪儿遇见过？那当然是！……等……奇怪？那个……是在哪儿来着……？

配置方法：

手动编辑（重启后生效）`config\hundun.fleet.amiya\ReminderFunction\HourlyChatConfig.json`

### 【指令】查看整点报时配置

*<子指令>: 查询报时*  

简单打印报时配置，仅作为调试。

>  -> /阿米娅 查询报时  
> <- HourlyChatConfig(chatTexts={0=……, 1=……, ……})

### 【定时】自定义提醒

定时触发。提醒任务来自data文件，可通过指令创建。

>  <- 现在是周日晚上10点。请博士记得完成本周剿灭作战。

配置方法：

1）手动编辑（重启后生效）`data\hundun.fleet.amiya\ReminderFunction\repositories\ReminderListRepository.json`   
2）指令创建，详见后文。

json文件数据结构说明：

|字段名|示例值|含义|
|---|---|---|
|cron|* 0 22 ? * 1|执行的时间条件。一个 [cron表达式](https://docs.oracle.com/cd/E12058_01/doc/doc.1014/e12030/cron_expressions.htm)|
|count|null|执行次数条件。无限次对应null|
|text|现在是周日晚上10点|提醒内容。即bot会发送的文本|

【注意】本项目的cron实现使用quartz库。特别地，其对于星期几的数值表示和某些其他标准中的表示不同，注意不要混淆。例如周日的的数值表示是1（而不是某些其他标准中的0或7）。具体如下，
```
("SUN", 1);
("MON", 2);
("TUE", 3);
("WED", 4);
("THU", 5);
("FRI", 6);
("SAT", 7);
```

### 【指令】创建提醒任务

*<子指令>: 创建提醒*  
*<指令参数列表>: 时间条件。用~代替cron表达式中的空格*
*<指令参数列表>: 执行次数条件。值域：x次，无限次*
*<指令参数列表>: 提醒内容。即bot会发送的文本*

>  -> /阿米娅 创建提醒 \*~0~22~?~\*~1 无限次 现在是周日晚上10点。请博士记得完成本周剿灭作战。  
>  <- OK

【注意】插件只会每分钟（的某一个毫秒）检查一次提醒任务，所以cron表达式中的毫秒条件只应填`*`。

### 【指令】查看所有提醒任务

*<子指令>: 查询提醒*  

>  -> /阿米娅 查询提醒  
>  <- items:  
>     id:0	ReminderItem(count=null, text=现在是周日晚上10点。请博士记得完成本周剿灭作战。, cron=* 0 22 ? * 7)

### 【指令】删除提醒任务

*<子指令>: 删除提醒*  
*<指令参数列表>: id。即查询提醒里看到的id*

>  -> /阿米娅 删除提醒 0  
>  <- OK

### 2.3 闲聊功能模块

#### 【群消息事件】复读

当群里连续3句发言相同时（包括发送相同表情/图片），bot也会发送一次该发言。

#### 【群消息事件】下班

当群消息包含“下班”时触发。根据是否是工作时间（周一至周五9点至17点），bot会做不同回复。

#### 【群消息事件】damedane

当群员发言里包含“damedane”，阿米娅会播放音频。

#### 【群消息事件】戳一戳

戳一戳阿米娅，阿米娅会发送随机的阿米娅表情图片。戳一戳任一群员，若存在响应配置，阿米娅会发送配置指定的图片。

配置方法：

戳阿米娅时，发送的图片为`data\hundun.fleet.amiya\AmiyaChatFunction\selfNudgeFaces`里的随机图片。

戳qq号：123456的群员时，若在`data\hundun.fleet.amiya\AmiyaChatFunction\otherNudgeFaces`里有名为`123456.png`的图片，则发送该图片。否则无事发生。

#### 【群消息事件】自定义回复

可自定义若干对触发词和消息内容候选。当群消息包含触发词时触发，发送一次对应的消息内容候选里的随机一条。

配置方法：

手动编辑（重启后生效）`config\hundun.fleet.amiya\AmiyaChatFunction\ListenConfig.json`

配置格式：

触发词：以`|`分割，满足其中任意一项即为触发。

配置样例：

```json
{ 
    "SINGLETON": {
        "listens": {
            "阿米娅可爱|兔兔可爱": [
                "虽然这可能是我一厢情愿的想法，但我希望罗德岛能成为大家的第二个故乡......",
                "嘿嘿，博士，悄悄告诉你一件事——我重新开始练小提琴了。",
                "博士，我们的脚下，是一条漫长的道路......也许这是一次没有终点的旅行，但如果是和您一起，我觉得，非常幸福。"
            ]
        }
    }
}
```

>  -> 阿米娅可爱嘿嘿嘿  
>  <- 嘿嘿，博士，悄悄告诉你一件事——我重新开始练小提琴了。  